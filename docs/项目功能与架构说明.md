# 91Writing 项目功能与架构说明

本文档从功能、流程、架构三方面分析 91Writing（91 写作）项目，并辅以 Mermaid 图表说明。

---

## 一、项目概述

**91Writing** 是一款基于 AI 的网文创作工具，使用 Vue 3 构建，提供从大纲生成、章节写作、短文创作到拆书分析的全流程能力。支持官方 91 写作 API 与自定义 OpenAI 兼容 API 双配置。

- **Demo**：https://xiezuo.91hub.vip
- **技术栈**：Vue 3、Vite、Pinia、Vue Router、Element Plus、WangEditor

---

## 二、主要功能模块

### 2.1 功能模块总览

```mermaid
flowchart TB
    subgraph 核心创作
        novel_management[小说列表与管理]
        writer[写作台]
        chapter_management[章节管理]
    end

    subgraph 辅助能力
        prompts_library[提示词库]
        genres[小说类型管理]
        tools_library[工具库]
    end

    subgraph 独立场景
        short_story[短文写作]
        book_analysis[拆书工具]
    end

    subgraph 目标与计费
        writing_goals[写作目标]
        token_billing[Token 计费]
    end

    subgraph 配置与设置
        api_config[API 配置]
        settings[系统设置]
    end

    novel_management --> writer
    novel_management --> chapter_management
    prompts_library --> writer
    prompts_library --> tools_library
    genres --> novel_management
    tools_library --> novel_management
```

### 2.2 路由与页面对应关系

```mermaid
flowchart LR
    subgraph 路由
        route_home["/"]
        route_novels["/novels"]
        route_writer["/writer"]
        route_prompts["/prompts"]
        route_genres["/genres"]
        route_chapters["/chapters"]
        route_goals["/goals"]
        route_billing["/billing"]
        route_tools["/tools"]
        route_short["/short-story"]
        route_book["/book-analysis"]
        route_config["/config"]
        route_settings["/settings"]
    end

    subgraph 页面组件
        page_home[HomePage]
        page_novels[NovelManagement]
        page_writer[Writer]
        page_prompts[PromptsLibrary]
        page_genres[GenreManagement]
        page_chapters[ChapterManagement]
        page_goals[WritingGoals]
        page_billing[TokenBilling]
        page_tools[ToolsLibrary]
        page_short[ShortStory]
        page_book[BookAnalysis]
        page_config[ApiConfig]
        page_settings[Settings]
    end

    route_home --> page_home
    route_novels --> page_novels
    route_writer --> page_writer
    route_prompts --> page_prompts
    route_genres --> page_genres
    route_chapters --> page_chapters
    route_goals --> page_goals
    route_billing --> page_billing
    route_tools --> page_tools
    route_short --> page_short
    route_book --> page_book
    route_config --> page_config
    route_settings --> page_settings
```

### 2.3 工具库（ToolsLibrary）子功能

工具库提供 10 类 AI 辅助工具，用于选题、设定与内容灵感：

```mermaid
flowchart TB
    subgraph 工具库_工具类型
        tool_outline[细纲生成器]
        tool_cheat[金手指生成器]
        tool_opening[黄金开篇生成器]
        tool_title[爆款书名生成器]
        tool_genre[爆款题材生成器]
        tool_brainstorm[脑洞生成器]
        tool_synopsis[简介生成器]
        tool_worldview[宏大世界观生成器]
        tool_character[人物生成器]
        tool_conflict[冲突生成器]
    end

    tools_library_page[工具库页面] --> tool_outline
    tools_library_page --> tool_cheat
    tools_library_page --> tool_opening
    tools_library_page --> tool_title
    tools_library_page --> tool_genre
    tools_library_page --> tool_brainstorm
    tools_library_page --> tool_synopsis
    tools_library_page --> tool_worldview
    tools_library_page --> tool_character
    tools_library_page --> tool_conflict
```

---

## 三、核心业务流程

### 3.1 小说从创建到写作的整体流程

```mermaid
flowchart LR
    subgraph 小说管理
        create_novel[创建小说]
        set_meta[设置标题/封面/简介/类型]
        gen_outline[AI 生成大纲]
        parse_chapters[解析为章节列表]
    end

    subgraph 写作台
        select_novel[选择小说进入写作台]
        manage_chapters[章节列表/人物/世界观/语料/事件线]
        edit_chapter[编辑当前章]
        ai_continue[AI 续写]
        ai_polish[AI 润色]
        save_publish[保存/发布]
    end

    create_novel --> set_meta
    set_meta --> gen_outline
    gen_outline --> parse_chapters
    parse_chapters --> select_novel
    select_novel --> manage_chapters
    manage_chapters --> edit_chapter
    edit_chapter --> ai_continue
    edit_chapter --> ai_polish
    ai_continue --> save_publish
    ai_polish --> save_publish
```

### 3.2 写作台（Writer）内部流程

```mermaid
flowchart TB
    subgraph 写作台入口
        writer_enter[进入写作台]
        load_novel_data[加载当前小说/章节/人物/世界观/语料]
    end

    subgraph 编辑态
        tab_editor[编辑 Tab]
        chapter_list[章节列表]
        add_chapter[新增章节: 手动 / AI 单章 / AI 批量]
        select_chapter[选择章节]
        rich_editor[富文本编辑器 WangEditor]
    end

    subgraph AI 能力
        ai_continue_btn[AI 续写]
        ai_polish_btn[AI 润色]
        ai_chat[AI 对话]
        stream_output[流式输出]
    end

    subgraph 侧边面板
        tab_characters[人物]
        tab_worldview[世界观]
        tab_corpus[语料库]
        tab_events[事件线]
    end

    writer_enter --> load_novel_data
    load_novel_data --> tab_editor
    load_novel_data --> tab_characters
    tab_editor --> chapter_list
    chapter_list --> add_chapter
    chapter_list --> select_chapter
    select_chapter --> rich_editor
    rich_editor --> ai_continue_btn
    rich_editor --> ai_polish_btn
    rich_editor --> ai_chat
    ai_continue_btn --> stream_output
    ai_polish_btn --> stream_output
```

### 3.3 数据流：用户操作 → Store → API

```mermaid
sequenceDiagram
    participant View as 视图/组件
    participant Store as Pinia novel store
    participant Api as apiService
    participant Backend as 后端 API

    View->>Store: 调用 action / 读写 state
    Store->>Api: 调用 generateTextStream / generateOutline 等
    Api->>Backend: HTTP 请求 (OpenAI 兼容)
    Backend-->>Api: 流式/JSON 响应
    Api-->>Store: 回调 onChunk / 更新状态
    Store-->>View: 响应式更新
```

---

## 四、技术架构

### 4.1 项目目录与分层

```mermaid
flowchart TB
    subgraph 入口与配置
        main_js[main.js]
        app_vue[App.vue]
        router_index[router/index.js]
        config_api[config/api.json]
    end

    subgraph 状态层
        store_novel[stores/novel.js]
    end

    subgraph 服务层
        service_api[services/api.js]
        service_billing[services/billing.js]
    end

    subgraph 视图层
        views[views/*.vue]
    end

    subgraph 组件层
        components[components/*.vue]
        writer_components[components/writer/*.vue]
    end

    main_js --> app_vue
    main_js --> router_index
    router_index --> views
    views --> components
    views --> store_novel
    views --> service_api
    store_novel --> service_api
    service_api --> service_billing
```

### 4.2 核心依赖关系

```mermaid
flowchart LR
    subgraph 前端框架
        vue[Vue 3]
        pinia[Pinia]
        vue_router[Vue Router]
        element_plus[Element Plus]
        wang_editor[WangEditor]
    end

    subgraph 工程与构建
        vite[Vite]
    end

    subgraph 应用核心
        novel_store[novel store]
        api_service[apiService]
        dashboard[Dashboard]
        writer_view[Writer]
        novel_management_view[NovelManagement]
    end

    vue --> pinia
    vue --> vue_router
    vue --> element_plus
    dashboard --> novel_store
    dashboard --> api_service
    writer_view --> novel_store
    writer_view --> wang_editor
    novel_management_view --> novel_store
    novel_store --> api_service
    vite --> vue
```

### 4.3 状态管理（Pinia novel store）结构概览

```mermaid
flowchart TB
    subgraph 小说与章节
        state_current_novel[currentNovel]
        state_outline[outline]
        state_chapters[chapters]
        state_selected_chapter[selectedChapter]
    end

    subgraph 写作辅助
        state_characters[characters]
        state_world_settings[worldSettings]
        state_corpus[corpus]
    end

    subgraph API 配置
        state_official_config[officialApiConfig]
        state_custom_config[customApiConfig]
        state_config_type[currentConfigType]
    end

    subgraph 生成与对话
        state_generating_content[generatedContent]
        state_ai_chat_history[aiChatHistory]
        state_is_generating[isGenerating* 系列]
    end

    subgraph 统计与分析
        state_article_stats[articleStats]
        state_word_count[wordCount]
    end

    novel_store[novel store] --> state_current_novel
    novel_store --> state_outline
    novel_store --> state_chapters
    novel_store --> state_characters
    novel_store --> state_official_config
    novel_store --> state_article_stats
```

---

## 五、API 服务能力概览

`services/api.js` 对外提供的主要能力（与功能、流程对应）：

| 能力           | 方法示例                     | 用途说明               |
|----------------|------------------------------|------------------------|
| 通用文本生成   | `generateText` / `generateTextStream` | 续写、润色、短文等流式/非流式 |
| 大纲           | `generateOutlineStream`       | 小说大纲流式生成       |
| 章节正文       | `generateChapterContentStream`| 写作台单章/批量写正文  |
| AI 对话        | `chatWithAI`                  | 写作台内 AI 对话       |
| 摘要/建议      | `generateSummary` / `getWritingAdvice` | 摘要、写作建议     |
| 文章分析       | `analyzeArticle`              | 统计、情感、标签、评分 |
| 人物/世界观    | `generateCharacter` / `generateWorldSetting` | 工具库或写作台设定 |
| 个性化生成     | `generatePersonalizedContent` | 结合语料库风格生成     |

---

## 六、小结

- **功能**：以小说列表与写作台为核心，配合提示词库、类型管理、工具库（10 类）、短文写作、拆书工具、写作目标与 Token 计费，并由 API 配置与系统设置支撑。
- **流程**：从「创建小说 → 生成大纲 → 解析章节 → 进入写作台 → 编辑/续写/润色 → 保存发布」形成主链路；拆书、短文、工具库为独立或辅助链路。
- **架构**：Vue 3 + Vite + Pinia + Vue Router + Element Plus，单 store（novel） + 统一 apiService，流式调用与 Token 计费在 `api.js` / `billing.js` 中完成。

更细的拆书流程与界面说明见 [拆书功能说明](./拆书功能说明.md)。
